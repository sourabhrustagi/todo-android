package com.mobizonetech.todo.domain.usecases.task

import com.mobizonetech.todo.domain.repository.TaskRepository
import io.mockk.coEvery
import io.mockk.mockk
import kotlinx.coroutines.test.runTest
import org.junit.Assert.assertEquals
import org.junit.Assert.assertFalse
import org.junit.Assert.assertTrue
import org.junit.Before
import org.junit.Test

class DeleteTaskUseCaseTest {

    private lateinit var deleteTaskUseCase: DeleteTaskUseCase
    private lateinit var taskRepository: TaskRepository

    @Before
    fun setup() {
        taskRepository = mockk()
        deleteTaskUseCase = DeleteTaskUseCase(taskRepository)
    }

    @Test
    fun `delete task should return success`() = runTest {
        val taskId = 1
        val expectedMessage = "Task deleted successfully"
        
        coEvery { taskRepository.deleteTask(taskId) } returns Result.success(expectedMessage)
        
        val result = deleteTaskUseCase(taskId)
        
        assertTrue(result.isSuccess)
        assertEquals(expectedMessage, result.getOrNull())
    }

    @Test
    fun `delete task should handle repository failure`() = runTest {
        val taskId = 1
        val errorMessage = "Task not found"
        
        coEvery { taskRepository.deleteTask(taskId) } returns Result.failure(Exception(errorMessage))
        
        val result = deleteTaskUseCase(taskId)
        
        assertTrue(result.isFailure)
        assertEquals(errorMessage, result.exceptionOrNull()?.message)
    }

    @Test
    fun `delete task with invalid ID should fail`() = runTest {
        val taskId = -1
        val errorMessage = "Invalid task ID"
        
        coEvery { taskRepository.deleteTask(taskId) } returns Result.failure(Exception(errorMessage))
        
        val result = deleteTaskUseCase(taskId)
        
        assertTrue(result.isFailure)
        assertEquals(errorMessage, result.exceptionOrNull()?.message)
    }

    @Test
    fun `delete task with zero ID should fail`() = runTest {
        val taskId = 0
        val errorMessage = "Invalid task ID"
        
        coEvery { taskRepository.deleteTask(taskId) } returns Result.failure(Exception(errorMessage))
        
        val result = deleteTaskUseCase(taskId)
        
        assertTrue(result.isFailure)
        assertEquals(errorMessage, result.exceptionOrNull()?.message)
    }

    @Test
    fun `delete task with large ID should succeed`() = runTest {
        val taskId = 999999
        val expectedMessage = "Task deleted successfully"
        
        coEvery { taskRepository.deleteTask(taskId) } returns Result.success(expectedMessage)
        
        val result = deleteTaskUseCase(taskId)
        
        assertTrue(result.isSuccess)
        assertEquals(expectedMessage, result.getOrNull())
    }

    @Test
    fun `delete non-existent task should fail`() = runTest {
        val taskId = 999
        val errorMessage = "Task not found"
        
        coEvery { taskRepository.deleteTask(taskId) } returns Result.failure(Exception(errorMessage))
        
        val result = deleteTaskUseCase(taskId)
        
        assertTrue(result.isFailure)
        assertEquals(errorMessage, result.exceptionOrNull()?.message)
    }

    @Test
    fun `network error should be handled properly`() = runTest {
        val taskId = 1
        val errorMessage = "Network error occurred"
        
        coEvery { taskRepository.deleteTask(taskId) } returns Result.failure(Exception(errorMessage))
        
        val result = deleteTaskUseCase(taskId)
        
        assertTrue(result.isFailure)
        assertEquals(errorMessage, result.exceptionOrNull()?.message)
    }

    @Test
    fun `database error should be handled properly`() = runTest {
        val taskId = 1
        val errorMessage = "Database error occurred"
        
        coEvery { taskRepository.deleteTask(taskId) } returns Result.failure(Exception(errorMessage))
        
        val result = deleteTaskUseCase(taskId)
        
        assertTrue(result.isFailure)
        assertEquals(errorMessage, result.exceptionOrNull()?.message)
    }

    @Test
    fun `multiple delete calls should work correctly`() = runTest {
        val taskId = 1
        val expectedMessage = "Task deleted successfully"
        
        coEvery { taskRepository.deleteTask(taskId) } returns Result.success(expectedMessage)
        
        val result1 = deleteTaskUseCase(taskId)
        val result2 = deleteTaskUseCase(taskId)
        
        assertTrue(result1.isSuccess)
        assertTrue(result2.isSuccess)
        assertEquals(expectedMessage, result1.getOrNull())
        assertEquals(expectedMessage, result2.getOrNull())
    }

    @Test
    fun `delete task should handle null response`() = runTest {
        val taskId = 1
        val errorMessage = "Task deletion failed"
        
        coEvery { taskRepository.deleteTask(taskId) } returns Result.failure(Exception(errorMessage))
        
        val result = deleteTaskUseCase(taskId)
        
        assertTrue(result.isFailure)
        assertEquals(errorMessage, result.exceptionOrNull()?.message)
    }

    @Test
    fun `delete completed task should succeed`() = runTest {
        val taskId = 1
        val expectedMessage = "Task deleted successfully"
        
        coEvery { taskRepository.deleteTask(taskId) } returns Result.success(expectedMessage)
        
        val result = deleteTaskUseCase(taskId)
        
        assertTrue(result.isSuccess)
        assertEquals(expectedMessage, result.getOrNull())
    }

    @Test
    fun `delete pending task should succeed`() = runTest {
        val taskId = 2
        val expectedMessage = "Task deleted successfully"
        
        coEvery { taskRepository.deleteTask(taskId) } returns Result.success(expectedMessage)
        
        val result = deleteTaskUseCase(taskId)
        
        assertTrue(result.isSuccess)
        assertEquals(expectedMessage, result.getOrNull())
    }

    @Test
    fun `delete task with permission error should fail`() = runTest {
        val taskId = 1
        val errorMessage = "Permission denied"
        
        coEvery { taskRepository.deleteTask(taskId) } returns Result.failure(Exception(errorMessage))
        
        val result = deleteTaskUseCase(taskId)
        
        assertTrue(result.isFailure)
        assertEquals(errorMessage, result.exceptionOrNull()?.message)
    }
} 